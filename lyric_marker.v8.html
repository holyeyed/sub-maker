<meta charset="utf-8">
<title>CHƯƠNG TRÌNH TẠO LYRIC BY HOLYEYED v8.26</title>
<style>
@keyframes blink {
  0% {
    opacity: 1;
	color: yellow;
	background-color: blue;
  }
  100% {
    opacity: 1;
    color: red;
	background-color: yellow;
  }
}
.btt{
border-right: solid 1px;
border-bottom: solid 2px;
background-color: #90f090;
text-align: center;
}
.btt2{
border-right: solid 1px;
border-bottom: solid 2px;
background-color: #d0d0d0;
}
</style>
<div id="allpart" style="">
<div style="display: inline-block; width:40%; background-color: pink">
<video id="myVideo" width="100%" height="60%" controls>
  <source src="media.mp4" type="video/mp4">
  <source src="media.mp3" type="audio/mp3">
  Your browser does not support HTML5 video.
</video>
<div>
<input value="select Media" id="slmedia" type='file' accept='.mp4,.webm,.mp3' onchange='loadvideo(event)' style='display: none' >
<input value="loadLyric" id="sllyric" type='file' accept='.txt,.lrc' onchange='loadlyric(event)' style='display: none' >
<input type="button" style="background-color: cyan; width: 100px; height: 40px;" value="0.Load video" onclick="document.getElementById('slmedia').click();" />
<input type="button" style="background-color: cyan; width: 100px; height: 40px;" value="1.Load lyric" onclick="document.getElementById('sllyric').click();" />
<input type="button" style="background-color: #ff7; width: 100px; height: 40px;" value="3.getLine" onclick="loadtext()" />
<input type="button" style="background-color: #ff7; width: 100px; height: 40px;" value="4.Start" onclick="playing()" />
<input type="button" style="background-color: #7f7; width: 100px; height: 40px;" id="export" value="5.Export lyric" onclick=lyric_export() />
</div>
</div>

<div style="display: inline-block; vertical-align:top; width: 59%; font-size: 22pt">
<div><input type="range" min="1" max="100" style="width: 100%; height: 10px; -webkit-appearance: none; background-color: #00dd00; outline: none; opacity: 0.7;  -webkit-transition: .2s; transition: opacity .2s;" value="50" class="slider" id="myRange"  /></div>
<div id="marker">
<table style="width: 100%"><tr><td class="btt" style="width: 50px;">321</td><td class="btt" style="width: 50px;">Act</td><td class="btt">lyric</td></tr></table>
</div>
</div>
</div>
<div style="display: inline-block; width: 40%" id="plaintext">
<div>
<span style="color:red; font-weight:bold;">2</span><span style="color: blue">.Select mode before processing the lyric!</span><br>
<input type="radio" name="mode" value="0" /> <label >Line mode</label>
<input type="radio" name="mode" value="1" checked /> <label >Word mode</label>
<span style="display: inline-block;text-align: right; width: 100px;">Speed:</span>
<input type="radio" name="speed" value="0.5" /> <label >slow</label>
<input type="radio" name="speed" value="1" checked /> <label >normal</label>
<input type="radio" name="speed" value="2" /> <label >fast</label>
</div>
<textarea id="inputtext" style="width: 640; height: 20%; width: 100%;">
Đây là chương trình đồng bộ lời nhạc
để thực hiện subtitle hoặc sub karaoke
* hướng dẫn:
- Chọn tệp âm thanh (mp4, mp3) nhấn 'load video'
select video file (mp4 hoặc mp3)
- Chọn tệp chứa lời nhạc (file txt) 'load lyric' hoặc dán trực tiếp vào hộp thoại dưới.
(select lyric file (text) or fill in the textbox below)
- Chọn chế độ dòng (line mode) hoặc từ (word mode) trước khi bắt đầu
(guide)
- phím 1,2,3 tốc độ chơi nhạc 0.5 
(press 1,2,3 for playing speed)
- nhấn 'toLine' để chuyển văn bản thành dữ liệu dòng
- nhấn 'Start' để bắt đầu đồng bộ
- phím 'Space' đồng bộ thời gian vào dòng hiện tại
(press 'space' to sync the lyric with playing time)
chúc các bạn thực hiện được nhiều sub đẹp
</textarea>
</div>
<div style="position: fixed; left: 0; top: 0; color: green; font-size: 12pt; background-color: white; padding: 2;"><span style="color: blue" >coding by holyeyed (2021)</span></div>
<textarea id="ass" style="display: none">[Script Info]
; Script generated by Aegisub 3.2.2
; http://www.aegisub.org/
Title: Default Aegisub file
ScriptType: v4.00+
WrapStyle: 0
ScaledBorderAndShadow: yes
YCbCr Matrix: None
PlayResX: 1280
PlayResY: 720

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: Default-furigana,Arial,48,&H00FFFFFF,&H000000FF,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,1,1,2,10,10,50,1
Style: Default,Arial,48,&H00FFFFFF,&H000000FF,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,2,2,2,10,10,50,1
Style: Male-furigana,Arial,48,&H00FFFFFF,&H00ff0000,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,1,1,2,10,10,50,1
Style: Male,Arial,48,&H00FFFFFF,&H00ff0000,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,2,2,2,10,10,50,1
Style: Duet,Arial,48,&H00FFFFFF,&H00ff00ff,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,2,2,2,10,10,50,1
Style: holyeyed,Arial,48,&H00FFFFFF,&H00ff00ff,&H00ffffff,&H00000000,-1,0,0,0,100,100,0,0,1,2,2,1,10,10,50,1
[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text</textarea>
<script>
var xong=false;
var subname="subtitle.ass";
var aline;
var atime;
var amode;
var nol=0;
var now;
var cline=0;
var cword=0;
var slider = document.getElementById('myRange');
var text=document.getElementById("inputtext");
var media=document.getElementById("myVideo");
media.volume = 0.5;
var mode=1;
var kara=["Dialogue: 0,time,Default,ff6000,0,0,0,,lyric","Dialogue: 0,time,Male,0030ff,0,0,0,,lyric","Dialogue: 0,time,Duet,ff60ff,0,0,0,,lyric","Dialogue: 0,time,holyeyed,cdown,0,0,0,,lyric"];

  var loadvideo = function(event) {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function(){
      var dataURL = reader.result;
      media.src = dataURL;
	  var vname=input.files[0].name;
	  subname=vname.substring(0,vname.lastIndexOf("."))+".ass";
    };
    reader.readAsDataURL(input.files[0]);
  };
  
  var loadlyric = function(event) {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function(){
      var dataURL = reader.result;
      var output = document.getElementById('inputtext');
      output.value = dataURL;
    };
    reader.readAsText(input.files[0]);
  };
//==================================Element on event
slider.addEventListener('input', (event) => {
  //document.getElementById("marker").innerHTML=slider.value;
  cline=slider.value;
  if (cline>=1){
  media.currentTime=atime[cline-1][0];
  }else{
  media.currentTime=0;
  }
  displine();
});

document.addEventListener("keydown", KeyCheck);  //or however you are calling your method
function KeyCheck(event)
{
   var KeyID = event.keyCode;
   console.log(KeyID);
   switch(KeyID)
   {
      case 8:
     // alert("backspace");
		loadtext();
      break; 
      case 49:
      console.log("speed 0.5");
	  media.playbackRate=0.5;
      break;
	  case 50:
	  console.log("speed 1.0");
	  media.playbackRate=1.0;
	  break;
	  case 51:
	  console.log("speed 2.0");
	  media.playbackRate=2.0;
	  break;
	  case 32:
	  if(!xong){
	  var curr=media.currentTime;
	  if(mode==0){
	  atime[cline][0]=curr;
	  cline++;}
	  else{
	  atime[cline][cword]=curr;
	  cword++;
	  if(cword==now[cline]){
	  cline++;
	  cword=0;
	  }
	  }
	  slider.value=cline;
	  displine();}
	  break;
	  case 83:
	  mode=mode==0?1:0;
	  cword=0;
	  document.getElementsByName("mode")[mode].checked=true;
	  console.log("mode switch="+mode);
	  break;
      default:
	  //alert(event.keyCode);
	  console.log(event.getCode)
      break;
   }
}
//thay đổi chế độ theo mode
const checkboxes = document.querySelectorAll('input[name="mode"]');
checkboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        console.log("current mode: "+(this.value==0?"line":"word"));
		mode=this.value;
        // You can add further logic here, e.g., enabling/disabling other elements
    });
});
//thay đổi tốc độ theo check box
var speed = document.querySelectorAll('input[name="speed"]');
speed.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      console.log("speed: "+this.value);
	  media.playbackRate=this.value;
    });
});

function getmode()
{
var sl=document.getElementsByName("mode");
for(var i=0;i<sl.length;i++){
if(sl[i].checked){
mode=i;
}
}
}
//chọn điểm đặt 3 2 1
function c3(line){
amode[line][0]=amode[line][0]==0?1:0;
displine();
}
//chọn điểm đặt chuyển giới
function cs(line){
var cm=amode[line][1]+1;
if(cm>2)cm=0;
for(var i=line;i<nol;i++)
amode[i][1]=cm;
displine();
}
function loadtext(){
xong=false;
getmode();
cline=0;
cword=0;
atime=new Array();
aline=new Array();
amode=new Array();
now=new Array();
var inputtext=document.getElementById("inputtext");
var ls=inputtext.value.split("\n");
var cl=0;
for(var i=0;i<ls.length;i++){
if(noblank(ls[i])){
var ws=ls[i].split(" ");
var cw=0;
var l0=new Array();
var t0=new Array();
for(var j=0;j<ws.length;j++){
if(ws[j]!=""){
l0[cw]=ws[j];
t0[cw]=0;
cw++;
}
}
aline[cl]=l0;
atime[cl]=t0;
amode[cl]=[0,0];
now[cl]=l0.length;
cl++;
}
}
nol=aline.length;
displine();
slider.min=0;
slider.max=aline.length;
slider.value=cline;
}

function playing(){
media.blur();
media.play();
document.activeElement.blur();}

function noblank(text){
var patt=/[a-z]/gi;
var rs=patt.test(text);
return rs;
}

function toTitleCase(str) {
   return str.charAt(0).toUpperCase() + str.substr(1);
}

function getline(i,j){
var rt="";
for(var x=0;x<aline[i].length;x++){
if(j>=0&&x>=j){
rt+="<span style=\"color:#909;font-size: 24pt\">"+aline[i][x]+" </span>";
}
else
rt+="<span style=\"font-size: 20pt;\">"+aline[i][x]+" </span>";
}
return rt;
}

function displine(){
var act=["A","B","AB"];
if (cline>=nol){
//stop the music, chuẩn bị xuất file ass
var ltime=new Array();
ltime[0]=atime[cline-1][0]+3;
atime[cline]=ltime;
media.pause();
document.getElementById("export").style.animation="blink 1s infinite";
xong=true;
}
var rs="<table style=\"width: 100%;\"><tr><td class=\"btt\">321</td><td class=\"btt\">Act</td><td class=\"btt\" style=\"\">"+"Lyric"+"</td></tr>";
//cword=3;
var cbox="";
if (cline>0){
cbox="<td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"c3("+(cline-1)+")\">"+amode[cline-1][0]+"</td><td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"cs("+cline+")\">"+act[amode[cline-1][1]]+"</td>";
rs+="<tr>"+cbox+"<td class=\"btt2\" style=\"\">"+msToTime(atime[cline-1][0]*1000)+"  "+getline(cline-1,-1)+"</td></tr>";
}
if(cline<nol){
cbox="<td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"c3("+(cline)+")\">"+amode[cline][0]+"</td><td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"cs("+cline+")\">"+act[amode[cline][1]]+"</td>";
rs+="<tr>"+cbox+"<td class=\"btt2\" style=\"color: #f44;\">=&Gg; "+""+"  "+getline(cline,cword)+"</td></tr>";
for(var i=1;i<5;i++){
var nline=Number(cline)+Number(i);
if (nline < nol)
{
cbox="<td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"c3("+nline+")\">"+amode[nline][0]+"</td><td class=\"btt2\" style=\"text-align: center; width: 50px;\" value=\"\" onclick=\"cs("+nline+")\">"+act[amode[nline][1]]+"</td>";
rs+="<tr>"+cbox+"<td class=\"btt2\" style=\"\">"+msToTime(atime[nline][0]*1000)+"  "+getline(nline,-1)+"</td></tr>"; }
}
}
rs+="</table>";
document.getElementById("marker").innerHTML=rs;
}

function msToTime(s) {
if (isNaN(s)) {
  // color is undefined
  return "00:00.00";
}
//s=s-200;
  var ms = s % 1000;
  s = (s - ms) / 1000;
  ms=Math.floor(ms/10);
  var secs = s % 60;
  s = (s - secs) / 60;
  var mins = s % 60;
  var hrs = (s - mins) / 60;
  //return pad(hrs) + ':' + 
  return pad(mins) + ':' + pad(secs) + '.' + pad(ms);
}
function msTosub(s) {
if (isNaN(s)) {
  // color is undefined
  return "00:00.00";
}
//s=s-200;
  var ms = s % 1000;
  s = (s - ms) / 1000;
  var secs = s % 60;
  s = (s - secs) / 60;
  var mins = s % 60;
  var hrs = (s - mins) / 60;
  //return pad(hrs) + ':' + 
  return pad(hrs)+':'+pad(mins) + ':' + pad(secs) + ',' + pad(Math.floor(ms),3);
}

function msToass(s) {
if (isNaN(s)) {
  // color is undefined
  return "00:00.00";
}
//s=s-200;
  var ms = s % 1000;
  s = (s - ms) / 1000;
  var secs = s % 60;
  s = (s - secs) / 60;
  var mins = s % 60;
  var hrs = (s - mins) / 60;
  //return pad(hrs) + ':' + 
  return pad(hrs)+':'+pad(mins) + ':' + pad(secs) + '.' + pad(Math.floor(ms/10));
}
  // Pad to 2 or 3 digits, default is 2
  function pad(n,x=2) {
    while((""+n).length<x)
	{n="0"+n;}
    return n;
  }
  

var obline=new Array();//[lstart,lend,lyric,karaoke]

function ob(){
for(var i=0;i<nol;i++){
try{
var dur=0;
var lyric="";
var karaoke="";
var temp=new Array();
var l0=aline[i];
var t0=atime[i];
var t1=atime[i+1];
temp[0]=t0[0];
//line mode
if(mode==0){
dur=t1[0]-t0[0];
if(dur>=5){
temp[1]=t0[0]+5;
}else{
temp[1]=t1[0];
}
lyric=getlyric(i);
temp[2]=lyric;
temp[3]=lyric;
//mode 1
}else{
var lwt=t0[now[i]-1];
var space=t1[0]-lwt;
if(space>=1||space<=0){
t0[now[i]]=lwt+1;
temp[1]=t0[now[i]];
}else{
t0[now[i]]=t1[0];
temp[1]=t1[0];
}
lyric=getlyric(i);
temp[2]=lyric;
for(var j=0;j<now[i];j++){
var wdur=parseInt((t0[j+1]-t0[j])*100);
karaoke+="{\K"+wdur+"}"+l0[j]+" ";
}
temp[3]=karaoke;
//mode 0
}
obline[i]=temp;
}catch(err){
console.log("not full lyric sync");
}}
}

function getlyric(i){
var lyric="";
for(var j=0;j<now[i];j++){
lyric+=aline[i][j]+" ";
}
return lyric.substring(0,lyric.length-1);
}

function lyric_export(){
ob();
var text="<div style=\"float: left; width: 50%; background-color: #99ff99\">Subtitle<br><textarea style=\"height:50%; width:100%\">";
var srt=""+document.getElementById("ass").value+"\n";
var scr="Timeline<br><textarea style=\"float: left; width: 100%; height: 40%\">";
var lyric="Lyric<br><textarea style=\"float: left; width: 100%; height: 40%\">";
//var patt = /{\K[0-9a-z]*}/gi;
for (var i=0;i<obline.length;i++){
var temp=obline[i];
if(amode[i][0]==1){
//chế độ thêm coutdown
//lấy thơi gian và thêm bộ đếm giờ
for(var y=0;y<3;y++){
var atime=msToass(temp[0]*1000-(3-y)*1000)+","+msToass(temp[0]*1000-(2-y)*1000);
var akara=kara[3].replace("time",atime);
akara=akara.replace("lyric","{\\fs50\\bord0\\shad0\\fscx150\\fscy150\\t(\\fscx10\\fscy10\\alpha&Hff&)}"+(3-y)+"");
srt+=akara+"\n";
}
}
var time=msToass(temp[0]*1000)+","+msToass(temp[1]*1000);
var nkara=kara[amode[i][1]].replace("time",time);
nkara=nkara.replace("lyric",temp[3]);
srt+=nkara+"\n";
//if(mode==1) aline[i] = aline[i].replaceAll(patt,"");
text+="["+msToTime(temp[0]*1000)+"] "+temp[2]+"\n";
lyric+=temp[2]+"\n";
scr+=(temp[0]).toFixed(3)+",";
}
srt+="";
srt=srt.replaceAll("{\K","{\\K");
var blob = new Blob([srt], {type: 'text/csv'});
lyric+="</textarea>";
scr+="</textarea >";
document.write(text+"</textarea>"+"<div style=\"text-align: center; \"><a style=\"color:yellow; font-weight: bold\" download=\""+subname+"\" href="+window.URL.createObjectURL(blob)+" ><div style=\"display: table-cell; width: 200; height: 100; margin: auto; background-color: #f77; text-align: center; vertical-align: middle;\">DOWNLOAD subtitle.ass</div></a></div>"+"</div><div style=\"float: right; width: 50%;background-color: #99ffff\">"+lyric+"<br>"+scr+"</div>");
}

</script>